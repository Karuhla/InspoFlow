{% extends 'base.html' %}
{% block title %} {{ image.alt_text }} {% endblock %}
{% load static %}
{% block content %}

<div class="image-detail-container">
  
    <div class="image-detail">
      <img src="{{ image.url }}" alt="{{ image.alt_text }}" style="width: 100%; max-width: 600px;">
    </div>
    {% if request.user.is_superuser %}
        <form action="{% url 'delete_image' image.id %}" method="POST" style="display:inline;">
            {% csrf_token %}
            <div class="container">
                <div class="dodaj_padding">
                <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this image?');">
                    Delete Image
                </button>
            </div>
            </div>
            </div>
        </form>
    {% endif %}    

    <div class="container mt-3">
        <div class="image-info">
            <h1>{{ image.alt_text }}</h1>

            {% if user.is_authenticated %}
                <form action="{% url 'like_image' image.id %}" method="post">
                    {% csrf_token %}
                    <div class="dodaj_padding">
                    <button type="submit" class="btn btn-light">
                        {% if user_has_liked %}
                            ‚ù§ Unlike ({{ image.likes.count }})
                        {% else %}
                            ü§ç Like ({{ image.likes.count }})
                        {% endif %}
                    </button></div>
                </form>
            {% else %}
            <div class="dodaj_padding">
                <button type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#loginModal" 
                    onclick="document.getElementById('login_next').value = window.location.pathname;">
                    ü§ç Like ({{ image.likes.count }})
                </button></div>
            {% endif %}

            {% if user.is_authenticated %}
                <form action="{% url 'comment_image' image.id %}" method="post">
                    {% csrf_token %}
                    <textarea name="comment_text" class="form-control mb-2" placeholder="Write a comment..." required></textarea>
                    
                    <button type="submit" class="btn btn-secondary">Comment</button>
                </form>
            {% else %}
            <textarea class="form-control mb-2" placeholder="Log in to comment..." disabled></textarea>
            <div class="dodaj_padding">
            <button type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#loginModal" 
            onclick="document.getElementById('login_next').value = window.location.pathname;">
                Log in to comment
            </button></div>

            {% endif %}

            <div class="comment-box">
                <div class="comments-section">
                    {% for comment in comments %}
                        <div class="comment-item d-flex align-items-start mb-3">
                            <div class="me-2">
                                {% if comment.user.profile.profile_picture_url %}
                                    <img src="{{ comment.user.profile.profile_picture_url }}" width="40" height="40">
                                {% else %}
                                    <img src="{% static 'profile_pictures/default.jpg' %}" width="40" height="40">
                                {% endif %}
                            </div>
                            <div>
                                <strong>{{ comment.user.username }}</strong>  
                                <p>{{ comment.text }}</p>
                                <small class="text-muted">{{ comment.created_at|date:"F j, Y, g:i a" }}</small>
                            </div>
                            <form action="{% url 'delete_comment' comment.id %}" method="post" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this comment?');">
                                {% csrf_token %}
                                {% if comment.user == request.user %}
                                    <button type="submit" class="btn btn-danger">Delete</button>
                                {% endif %}
                            </form>            
                        </div>
                        <hr> 
                    {% empty %}

                        <div class="dolje">No comments yet. Be the first to comment!</div>
                    {% endfor %}
                </div>
            </div>
            
    
        {% if user.is_authenticated %}
        <form method="POST" action="{% url 'save_image_to_board' image.id %}">
            {% csrf_token %}
            <input type="hidden" name="selected_board_id" id="selectedBoardId">

            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="boardDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Select a board
                </button>
                <ul class="dropdown-menu" aria-labelledby="boardDropdown">
                    {% for board in boards %}
                        <li>
                            <a class="dropdown-item board-selection" href="#" data-value="{{ board.id }}">{{ board.title }}</a>
                        </li>
                    {% empty %}
                        <li><span class="dropdown-item disabled">No boards available</span></li>
                    {% endfor %}
                </ul>
            </div>

            <div class="dodaj_padding">
                <button type="submit" class="btn" id="saveButton" style="display: none; background-color: #d9a29d; border-color: #d9a29d; color: white;">
                    Save to board
                </button>
                
            <label for="new_board_name">Or create a new board:</label>
            <input type="text" class="form-control mb-2" name="new_board_name" id="new_board_name" placeholder="Enter new board title">
            <button type="submit" class="btn" style="background-color: #d9a29d; border-color: #d9a29d; color: white;">Save to board</button>

        </form>

        <script>
            document.addEventListener("DOMContentLoaded", function() {
                let saveButton = document.getElementById("saveButton");
                let boardDropdown = document.getElementById("boardDropdown");

                document.querySelectorAll(".board-selection").forEach(item => {
                    item.addEventListener("click", function(event) {
                        event.preventDefault();
                        
                        let boardId = this.getAttribute("data-value");
                        let boardName = this.textContent;

                        document.getElementById("selectedBoardId").value = boardId;

                        boardDropdown.textContent = boardName;

                        saveButton.style.display = "block";
                    });
                });
            });
        </script>

        {% else %}
        <button type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#loginModal" 
        onclick="document.getElementById('login_next').value = window.location.pathname;">
            Log in to save to a board
        </button>
        {% endif %}

        </div>
    </div>
</div>
{% endblock %}
